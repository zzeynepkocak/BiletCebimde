@model IEnumerable<BiletCebimde.ViewModels.EventViewModel>

@{
    ViewData["Title"] = "Etkinlikler";
}

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Etkinlikler</h2>
        @if (User.IsInRole("Admin") || User.IsInRole("Organizer"))
        {
            <a asp-action="Create" class="btn btn-primary btn-sm">
                Yeni Etkinlik
            </a>
        }
    </div>

    <!-- Filtreleme ve Arama Formu -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Etkinlik Filtrele</h5>
            <form asp-action="Index" method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="searchString" class="form-label">Ara</label>
                    <input type="text" 
                           class="form-control" 
                           id="searchString" 
                           name="searchString" 
                           value="@(ViewBag.SearchString ?? string.Empty)" 
                           placeholder="Etkinlik adı veya açıklama ara...">
                </div>
                <div class="col-md-3">
                    <label for="categoryId" class="form-label">Kategori</label>
                    <select class="form-select" 
                            id="categoryId" 
                            name="categoryId">
                        <option value="">Tüm Kategoriler</option>
                        @if (ViewBag.Categories != null)
                        {
                            var categories = ViewBag.Categories as List<BiletCebimde.ViewModels.CategoryViewModel>;
                            @if (categories != null)
                            {
                                @foreach (var category in categories)
                                {
                                    var isSelected = ViewBag.CategoryId != null && ViewBag.CategoryId == category.Id;
                                    <option value="@category.Id" selected="@isSelected">
                                        @category.Name
                                    </option>
                                }
                            }
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="venueId" class="form-label">Mekan</label>
                    <select class="form-select" 
                            id="venueId" 
                            name="venueId">
                        <option value="">Tüm Mekanlar</option>
                        @if (ViewBag.Venues != null)
                        {
                            var venues = ViewBag.Venues as List<BiletCebimde.ViewModels.VenueViewModel>;
                            @if (venues != null)
                            {
                                @foreach (var venue in venues)
                                {
                                    var isSelected = ViewBag.VenueId != null && ViewBag.VenueId == venue.Id;
                                    <option value="@venue.Id" selected="@isSelected">
                                        @venue.Name
                                    </option>
                                }
                            }
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="startDate" class="form-label">Başlangıç</label>
                    <input type="date" 
                           class="form-control" 
                           id="startDate" 
                           name="startDate" 
                           value="@(ViewBag.StartDate?.ToString("yyyy-MM-dd") ?? string.Empty)">
                </div>
                <div class="col-md-2">
                    <label for="endDate" class="form-label">Bitiş</label>
                    <input type="date" 
                           class="form-control" 
                           id="endDate" 
                           name="endDate" 
                           value="@(ViewBag.EndDate?.ToString("yyyy-MM-dd") ?? string.Empty)">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="bi bi-search"></i> Filtrele
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">
                        Temizle
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Etkinlik Listesi -->
    @if (Model != null && Model.Any())
    {
        <div class="row">
            @foreach (var item in Model)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 event-card">
                        <div class="event-image" style="height: 200px; overflow: hidden; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                            {
                                <img src="@item.ImageUrl" alt="@item.Title" class="img-fluid" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\'font-size: 3rem;\'>@item.CategoryName</span>';" />
                            }
                            else
                            {
                                <span style="font-size: 3rem;">@item.CategoryName</span>
                            }
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <span class="badge bg-info">@item.CategoryName</span>
                                @if (item.RegisteredCount >= item.Capacity)
                                {
                                    <span class="badge bg-danger">Dolu</span>
                                }
                                else if (item.Date < DateTime.Now)
                                {
                                    <span class="badge bg-secondary">Geçmiş</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Açık</span>
                                }
                            </div>
                            
                            <h5 class="card-title">@item.Title</h5>
                            
                            <p class="card-text">
                                @if (item.Description != null && item.Description.Length > 80)
                                {
                                    @item.Description.Substring(0, 80)
                                    <text>...</text>
                                }
                                else
                                {
                                    @item.Description
                                }
                            </p>
                            
                            <div class="mb-2">
                                <small class="text-muted">
                                    <strong>Tarih:</strong> @item.Date.ToString("dd.MM.yyyy HH:mm")
                                </small><br>
                                <small class="text-muted">
                                    <strong>Yer:</strong> @item.VenueName
                                </small><br>
                                <small class="text-muted">
                                    <strong>Kontenjan:</strong> @item.RegisteredCount / @item.Capacity
                                </small>
                            </div>
                            
                            <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-primary btn-sm">
                                Detaylar
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> 
            Henüz etkinlik bulunmamaktadır.
            @if (User.IsInRole("Admin") || User.IsInRole("Organizer"))
            {
                <a asp-action="Create" class="alert-link">İlk etkinliği oluşturmak için tıklayın.</a>
            }
        </div>
    }
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
}

